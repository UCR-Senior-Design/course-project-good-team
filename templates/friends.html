<!DOCTYPE html>
<html lang = "en">
    <head>
        <meta charset="UTF-8">
        <title>Friends</title>
        <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/friends_styles.css') }}">
    </head>
    <body>
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <img src="{{ icon_link }}">
                </div>
                <div class="welcome">
                    <span class="weltext">Welcome to <span class="friend">Friendify</span>, <span id="username">{{ username }}</span></span>
                </div>
              <ul class="nav--list">
                <li class="item"><button><a href="/">Home</a></button></li>
                <li class="item"><button><a href="/about">About</a></button></li>
                <li class="item"><button><a href="/profile/{{ username }}">Profile</a></button></li>
                <li class="item"><button><a href="/friends">Friends</a></button></li>
                {% if is_logged_in %}
                <li class="logout"><button><a href="/logout" class="out">Logout</a></button></li>
                {% else %}
                <li class="item"><button><a href="https://accounts.spotify.com/authorize?client_id=4f8a0448747a497e99591f5c8983f2d7&response_type=code&redirect_uri=http://127.0.0.1:8080/callback&show_dialogue=true&scope=user-read-private user-top-read playlist-read-private playlist-read-collaborative user-follow-read" class="log">Login</a></button></li>
                {% endif %}
              </ul>
            </nav>
          </div>

        <div class="centered-text">
            <h1>Your Friendify Friends</h1>
            <div class="spacer"></div>
            {% if friends %}
                <table>
                    <thead>
                        <tr>
                            <th>Profile</th>
                            <th>Friend Username</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for friend in friends %}
                            <tr>
                                <!-- Make profile picture clickable -->
                                <td>
                                    <a href="{{ url_for('profile', username=friend) }}">
                                        <img src="{{ profile_pics[friend] }}" alt="Profile Pic" class="friend-profile-pic">
                                    </a>
                                </td>
                                <!-- Make friend username clickable -->
                                <td>
                                    <a href="{{ url_for('profile', username=friend) }}">{{ friend }}</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>You have no friends added.</p>
            {% endif %}
        </div>
        </body>
        </html>


        <div class="spacer"></div>
        <div class="centered-text">
            <button class="item" onclick="askForFriend()">
                <span>Add Friend</span>
            </button>
        </div>    
        <script>
        function askForFriend() {
            var friendName = prompt("Enter friend's name:");
            
            if (friendName !== null) {
                    fetch('/addfriend', {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json',
                        },
                    body: JSON.stringify({ friendName: friendName }),
                    })
                    .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                })
                .catch(error => {
                        console.error('Error:', error);
                });
            }
            }
        </script>

        <div class="topspacer"></div>

        <div class="pending-requests">
            <h2>You have {{ friend_requests|length }} pending friend request(s)</h2>
            {% for request in friend_requests %}
            <div class="request">
                {{ request }}
                <button onclick="acceptFriendRequest('{{ request }}')">✓</button>
                <button onclick="declineFriendRequest('{{ request }}')">✕</button>
        </div>
        {% endfor %}
        </div>

        <script>
            function acceptFriendRequest(requesterUsername) {
                fetch('/acceptfriend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ requesterUsername: requesterUsername })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload(); // Reload the page to update the list
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
            
            function declineFriendRequest(requesterUsername) {
                fetch('/declinefriend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ requesterUsername: requesterUsername })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    location.reload(); // Reload the page to update the list
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
            </script>


        <div class="topspacer"></div>
        <div class="centered-text">
            <p>Login on other platforms and exchange handles!</p>
        </div>
        <footer>
            <ul>
                <li class="footer"><a href="https://facebook.com">Facebook</a></li>
                <li class="footer"><a href="https://twitter.com">Twitter</a></li>
                <li class="footer"><a href="https://www.instagram.com">Instagram</a></li>
            </ul>
        </footer>

        <script>
            window.onload = function() {
                const username = "{{ username }}"; // Use the value from Flask session
                document.getElementById('username').textContent = username;
            };
        </script>

    <div class = "page-marker">
        <footer>FRIENDS</footer>
    </div>
    </body>
</html>
